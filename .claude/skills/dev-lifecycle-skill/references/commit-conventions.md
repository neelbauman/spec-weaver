# コミットメッセージ規約

Doorstop + Gherkin + Spec-Weaver で仕様管理されたプロジェクトにおける、
コミットメッセージの規約を定義する。

---

## 基本形式

**Conventional Commits** 形式に従う:

```
<type>(<scope>): <summary>

<body>（任意）

<footer>（任意）
```

### scope に仕様IDを記載するルール

- 仕様に紐づく変更の場合、scope に仕様IDを記載する
- 複数の仕様に関連する場合は、最も関連の強いIDを1つ選ぶ
- 仕様に紐づかない変更（CI設定、依存更新等）は scope を省略してよい

---

## type 一覧

| type | 意味 | 使用場面 |
|---|---|---|
| `feat` | 新機能の追加 | 新しい機能コードの実装 |
| `fix` | バグ修正 | 既存機能の不具合を修正 |
| `spec` | 仕様の追加・更新 | REQ / SPEC / `.feature` / DESIGN / PLAN / ADR / RESEARCH の変更 |
| `refactor` | リファクタリング | 機能変更を伴わないコード改善 |
| `test` | テストの追加・修正 | テストコードのみの変更 |
| `docs` | ドキュメントの更新 | README、コメント等の変更 |
| `chore` | その他の雑務 | CI設定、依存更新、ビルド設定等 |

---

## scope の書き方

### 仕様IDを使用する場合

```
feat(SPEC-001): パスワードハッシュ化ロジックを実装
fix(SPEC-003): audit コマンドの孤児タグ検出漏れを修正
spec(REQ-005): テスト結果統合の要件を追加
spec(PLAN-001): 認証機能の実装計画を作成
spec(ADR-001): セッション管理方式の技術選定を記録
```

### 仕様IDを使用しない場合

```
chore: GitHub Actions の CI ワークフローを更新
docs: README にインストール手順を追加
refactor: 共通ユーティリティを分離
```

### 複数の仕様にまたがる場合

最も関連の強いIDを scope に記載し、body で他の関連IDに言及する:

```
feat(SPEC-001): 認証システムを実装

- SPEC-001 パスワードハッシュ化
- SPEC-002 セッション管理
- REQ-001 の受け入れ基準を満たす
```

---

## summary の書き方

- **日本語**で簡潔に記述する
- **体言止め**または**動詞の終止形**で終える
- 50文字以内を目安とする
- 「何をしたか」ではなく「何が変わったか」を書く

---

## 良い例

```
feat(SPEC-001): パスワードハッシュ化ロジックを実装
```
- type が適切（新機能 → feat）
- scope に仕様ID
- summary が具体的

```
fix(SPEC-003): audit コマンドで testable:false のSPECが誤検出される問題を修正
```
- バグ修正 → fix
- 何が問題だったかが分かる

```
spec(REQ-010): タイムスタンプ管理の要件を追加

- created_at / updated_at のカスタム属性を定義
- SPEC-011, SPEC-012, SPEC-013 の親要件として追加
```
- 仕様変更 → spec
- body で関連仕様に言及

```
spec(PLAN-002): build コマンド拡張の実装計画を作成
```
- PLANドキュメントの作成 → spec

---

## 悪い例

```
update code
```
- type なし、scope なし、summary が曖昧

```
feat: いろいろ修正
```
- feat なのに「修正」は矛盾、summary が曖昧

```
feat(SPEC-001,SPEC-002,SPEC-003): 認証とセッションと監査を実装
```
- scope に複数IDを詰め込みすぎ（1つに絞り、body で言及する）

```
save
```
- 意味のないメッセージ

---

## コミット粒度の指針

### 1コミットに含めるべき範囲

- **1つの論理的な変更単位**にする
- 仕様の変更とそれに対応するコードの変更は**同じコミット**に含める
- テストコードは対応するプロダクションコードと**同じコミット**に含める

### 分けるべきケース

| 別コミットにする | 理由 |
|---|---|
| リファクタリングと新機能追加 | レビュー時に変更の意図が明確になる |
| 仕様の追加（spec）と実装（feat） | 仕様レビューと実装レビューを分離できる |
| 複数の独立したバグ修正 | revert が容易になる |

### 同じコミットにすべきケース

| 同じコミットにする | 理由 |
|---|---|
| SPEC の更新とそれに対応するコード変更 | 仕様とコードの一貫性を保つ |
| `.feature` の追加と対応するテストコード | テストの意図が明確になる |
| PLAN の作成と関連する SPEC へのリンク設定 | 計画と仕様の関連が明確になる |

---

## コミット前の確認事項

コミット前に以下を確認する:

```bash
# 1. 変更内容の確認
git diff --staged

# 2. コミットに含めるべきファイルが全て staged されているか
git status

# 3. テストが通過するか
uv run pytest tests/ -q

# 4. 仕様の整合性
uv run spec-weaver audit ./specification/features
```
