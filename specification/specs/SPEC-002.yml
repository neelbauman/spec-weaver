active: true
derived: false
header: |
  データ抽出基盤
level: 1.1
links:
- REQ-001: sQI3PDVLr4t_7FzvaBW2KfO6i0kUFnK0vEnVRhJAA4M=
- REQ-002: AL9bDV_13Z_dFORw5rjP1YoJvrpxV9BwxqcTBuTGPsA=
normative: true
ref: ''
reviewed: D4KjmcrpAg3v3-QAXCdB7bTOowaShXstZqoS8dZBTuI=
status: implemented
testable: true
text: |
  ## 概要
  Doorstop と Gherkin からのデータ抽出基盤を定義する。

  ## データ抽出フロー
  ```mermaid
  sequenceDiagram
      participant CLI as Spec-Weaver CLI
      participant DS as Doorstop API
      participant GH as Gherkin Parser
      participant DB as Data Matrix

      CLI->>DS: build() tree
      DS-->>CLI: List of Items (REQ/SPEC)
      CLI->>CLI: Filter (active: true, testable: true)

      CLI->>GH: parse(feature_files)
      GH-->>CLI: AST with Tags & Locations

      CLI->>DB: Map Tags to Spec IDs
      DB-->>CLI: Integrated Data Model
  ```

  ## 詳細仕様

  ### Doorstopの解析
  - 正規表現でのYAMLパースは行わず、Doorstopの公式Python API（`doorstop.build()`）を使用すること
  - `Tree` -> `Document` -> `Item` の構造を正しく走査すること

  ### Gherkinの解析
  - `gherkin-official` パーサーを用いて抽象構文木（AST）を構築すること
  - タグの文字列だけでなく、そのタグが属する「シナリオ名」「ファイル相対パス」「行番号」の
    メタデータを正確に抽出すること
  - Gherkin のタグ継承（Effective Tags）に関する詳細仕様は **SPEC-021** を参照すること

  ### カスタム属性の評価
  - Doorstopの `testable: false` 属性を評価すること
  - UIの色やライセンス表記など「自動テスト不可能な仕様」を監査の対象外（スキップ扱い）
    として処理すること
